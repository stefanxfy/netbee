# Linux网络数据包处理完整流程图

## 网络数据包从进入到出去的完整链路

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  物理层     │      │  链路层     │      │  网络层     │      │  传输层     │      │  应用层     │
│ (Physical)  │      │  (Link)     │      │  (Network)  │      │ (Transport) │      │  (Application)│
└─────────────┘      └─────────────┘      └─────────────┘      └─────────────┘      └─────────────┘
        │                    │                    │                    │                    │
        ▼                    ▼                    ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         网络数据包处理流程                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
        │
        │  数据包接收路径（入站）
        ▼
┌─────────────────────────────────────────────────────────┐
│ 1. 物理层接收（网卡硬件）                                 │
│    - 物理介质（网线、无线）接收电信号/光信号                │
│    - 网卡PHY芯片转换信号为数字数据                        │
│    - 网卡MAC芯片进行CRC校验和地址过滤                      │
└─────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────┐
│ 2. 链路层处理（网卡驱动）                                 │
│    - 网卡触发硬件中断（IRQ）                              │
│    - 驱动程序分配套接字缓冲区（skb）                      │
│    - 通过DMA将数据包从网卡写入系统内存                     │
│    - 调用netif_rx()/napi_schedule()将数据包送入协议栈       │
│    - 标记NET_RX_SOFTIRQ软中断                            │
└─────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────┐
│ 3. Netfilter PREROUTING 钩子点                           │
│    - 位置：网络层入口，路由查找之前                        │
│    - 作用：DNAT（目的地址转换）、连接跟踪初始化              │
│    - 钩子值：NF_INET_PRE_ROUTING (0)                     │
└─────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────┐
│ 4. 网络层处理（IP层）                                    │
│    - IP头部解析                                          │
│    - 路由查找（确定数据包是发往本机还是需要转发）           │
│    - TTL减1、校验和重新计算                               │
└─────────────────────────────────────────────────────────┘
        │
        ├─────────────┬─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  本机数据包  │ │  转发数据包  │ │  发送数据包  │
│  处理路径    │ │  处理路径    │ │  处理路径    │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  Netfilter  │ │  Netfilter  │ │  应用程序   │
│ LOCAL_IN    │ │  FORWARD    │ │  数据生成   │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  传输层处理  │ │  路由后处理  │ │  Netfilter  │
│ (TCP/UDP)   │ │ (修改TTL等) │ │ LOCAL_OUT   │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │             │
        ▼             ▼             ▼
┌─────────────────────────────────────────────────────────┐
│ 5. Netfilter POSTROUTING 钩子点                          │
│    - 位置：网络层出口，准备离开系统之前                     │
│    - 作用：SNAT（源地址转换）、最终数据包修改               │
│    - 钩子值：NF_INET_POST_ROUTING (4)                    │
└─────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────┐
│ 6. 链路层发送处理（网卡驱动）                              │
│    - 数据包通过Qdisc（队列规则）进入发送队列                │
│    - 驱动程序进行数据包封装                               │
│    - 通过DMA将数据包从内存传输到网卡硬件                    │
└─────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────┐
│ 7. 物理层发送（网卡硬件）                                 │
│    - 网卡将数字数据转换为电信号/光信号                      │
│    - 通过物理介质发送数据                                  │
└─────────────────────────────────────────────────────────┘
```

## 详细说明各组件和流程

### 1. 物理层接收过程
- **物理信号转换**：网卡PHY芯片将网线传来的电信号转换为数字信号
- **硬件过滤**：MAC芯片检查目的MAC地址是否匹配或为广播地址
- **CRC校验**：验证数据包完整性，丢弃损坏的数据包

### 2. 链路层处理过程
- **中断处理**：网卡触发硬件中断通知CPU有数据到达
- **数据传输**：使用DMA（直接内存访问）技术将数据包从网卡传输到系统内存，无需CPU干预
- **缓冲区分配**：驱动程序分配sk_buff结构体（套接字缓冲区）来存储数据包
- **软中断调度**：调用netif_rx()或napi_schedule()函数，将数据包传递给协议栈，并标记NET_RX_SOFTIRQ软中断

### 3. Netfilter钩子点详解

#### PREROUTING (NF_INET_PRE_ROUTING = 0)
- **位置**：数据包进入网络层后，路由决策之前
- **主要功能**：连接跟踪初始化、目的地址转换(DNAT)、数据包标记
- **对应iptables表**：raw表、mangle表、nat表

#### LOCAL_IN (NF_INET_LOCAL_IN = 1)
- **位置**：路由决策后，数据包确定是发送到本机
- **主要功能**：输入数据包过滤、连接状态检查
- **对应iptables链**：filter表INPUT链

#### FORWARD (NF_INET_FORWARD = 2)
- **位置**：路由决策后，数据包需要转发到其他主机
- **主要功能**：转发数据包过滤、流量控制
- **对应iptables链**：filter表FORWARD链

#### LOCAL_OUT (NF_INET_LOCAL_OUT = 3)
- **位置**：本机生成的数据包，在离开应用层进入网络层时
- **主要功能**：输出数据包过滤、连接跟踪、源地址选择
- **对应iptables表**：raw表、mangle表、nat表(OUTPUT链)、filter表(OUTPUT链)

#### POSTROUTING (NF_INET_POST_ROUTING = 4)
- **位置**：所有数据包离开系统之前，在链路层封装之前
- **主要功能**：源地址转换(SNAT)、数据包最终修改
- **对应iptables表**：mangle表、nat表(POSTROUTING链)

### 4. 网络层处理过程
- **IP头部解析**：检查版本、头部长度、服务类型等字段
- **路由查找**：根据目的IP地址确定数据包的下一步走向
  - 目的地址是本机：发送到LOCAL_IN处理
  - 目的地址是其他主机且开启转发：发送到FORWARD处理
- **数据包转发处理**：修改TTL、重新计算校验和、更新路由信息

### 5. 传输层处理过程
- **TCP/UDP头部解析**：提取源端口、目的端口、序列号等信息
- **连接管理**：对于TCP，处理三次握手、四次挥手等连接状态
- **数据重组**：对于分片的数据包，进行重组
- **校验和验证**：确保数据传输的完整性

### 6. 应用层处理过程
- **协议解析**：根据传输层端口号识别应用层协议（HTTP、DNS、SSH等）
- **数据交付**：将数据交付给相应的应用程序进程
- **数据生成**：应用程序生成新的数据发送请求

## Netfilter钩子点与iptables表链对应关系

| Netfilter钩子点 | iptables表链 | 主要功能 |
|--------------|------------|---------|
| PREROUTING | raw/PREROUTING, mangle/PREROUTING, nat/PREROUTING | 连接跟踪初始化、DNAT |
| LOCAL_IN | filter/INPUT | 输入数据包过滤 |
| FORWARD | filter/FORWARD | 转发数据包过滤 |
| LOCAL_OUT | raw/OUTPUT, mangle/OUTPUT, nat/OUTPUT, filter/OUTPUT | 输出数据包过滤、连接跟踪 |
| POSTROUTING | mangle/POSTROUTING, nat/POSTROUTING | SNAT、最终数据包修改 |

## netbee项目中的相关实现

在netbee项目中，我们可以看到它通过eBPF程序监控Netfilter的关键函数来实现网络安全监控：

1. **nf_hook_slow**：Netfilter框架的核心函数，负责调用注册在各个钩子点的处理函数
2. **ipt_do_table**：iptables的核心函数，负责匹配和执行规则表中的规则

通过挂接kprobe和kretprobe，netbee可以收集防火墙事件信息，包括钩子点位置、规则匹配结果等，实现细粒度的网络安全监控。

## 数据包处理返回值说明

Netfilter钩子函数可以返回以下值来控制数据包的处理流程：

- **NF_DROP (0)**：丢弃数据包，不再继续传输
- **NF_ACCEPT (1)**：接受数据包，继续正常传输
- **NF_STOLEN (2)**：接管数据包，Netfilter不再处理
- **NF_QUEUE (3)**：将数据包放入用户空间队列
- **NF_REPEAT (4)**：重新调用当前钩子函数

## 总结

Linux网络协议栈和Netfilter框架共同构成了一个强大、灵活的网络数据包处理系统。通过在协议栈关键路径上设置的5个钩子点，Netfilter提供了数据包过滤、网络地址转换、连接跟踪等核心功能，为防火墙、入侵检测系统等网络安全工具提供了基础架构。

从物理层接收数据包，经过链路层、网络层、传输层到应用层的处理，再经过Netfilter各个钩子点的检查和修改，最后从物理层发送出去，形成了一个完整的网络数据包处理链路。